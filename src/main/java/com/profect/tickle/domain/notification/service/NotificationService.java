package com.profect.tickle.domain.notification.service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.profect.tickle.domain.member.entity.Member;
import com.profect.tickle.domain.member.service.MemberService;
import com.profect.tickle.domain.notification.dto.response.NotificationResponseDto;
import com.profect.tickle.domain.notification.dto.response.NotificationSseResponseDto;
import com.profect.tickle.domain.notification.entity.Notification;
import com.profect.tickle.domain.notification.entity.NotificationTemplate;
import com.profect.tickle.domain.notification.entity.NotificationTemplateId;
import com.profect.tickle.domain.notification.event.reservation.event.PerformanceModifiedEvent;
import com.profect.tickle.domain.notification.event.reservation.event.ReservationSuccessEvent;
import com.profect.tickle.domain.notification.mapper.NotificationMapper;
import com.profect.tickle.domain.notification.mapper.NotificationTemplateMapper;
import com.profect.tickle.domain.notification.repository.NotificationRepository;
import com.profect.tickle.domain.notification.repository.SseRepository;
import com.profect.tickle.domain.performance.dto.response.PerformanceDto;
import com.profect.tickle.domain.performance.service.PerformanceService;
import com.profect.tickle.domain.reservation.dto.response.reservation.ReservationDto;
import com.profect.tickle.domain.reservation.dto.response.reservation.ReservedSeatDto;
import com.profect.tickle.domain.reservation.service.ReservationService;
import com.profect.tickle.global.exception.BusinessException;
import com.profect.tickle.global.exception.ErrorCode;
import com.profect.tickle.global.security.util.SecurityUtil;
import com.profect.tickle.global.status.service.StatusService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import java.io.IOException;
import java.time.Instant;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class NotificationService {

    private static final Long TIME_OUT = 60 * 60 * 1000L;

    private final MemberService memberService;
    private final StatusService statusService;
    private final NotificationTemplateService notificationTemplateService;
    private final PerformanceService performanceService;
    private final MailService mailService;
    private final ReservationService reservationService;

    private final NotificationTemplateMapper notificationTemplateMapper;
    private final NotificationMapper notificationMapper;
    private final NotificationRepository notificationRepository;
    private final SseRepository sseRepository;

    /**
     * ÏµúÏã† ÏïåÎ¶º Ï°∞Ìöå
     */
    @Transactional(readOnly = true)
    public List<NotificationResponseDto> getRecentNotificationListByMemberId(Long memberId, int limit) {
        return notificationMapper.getRecentNotificationListByMemberId(memberId, limit);
    }

    /**
     * ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨
     */
    @Transactional
    public void markAsRead(Long notificationId, Long memberId) {
        Notification notification = notificationRepository.findById(notificationId)
                .orElseThrow(() -> new BusinessException(ErrorCode.NOTIFICATION_NOT_FOUND));
        if (!notification.getReceivedMember().getId().equals(memberId)) {
            throw new BusinessException(ErrorCode.NOTIFICATION_ACCESS_DENIED);
        }
        notification.markAsRead(statusService.getReadStatusForNotification());
    }

    /**
     * SSE Ïó∞Í≤∞
     */
    public SseEmitter sseConnect(String lastEventId) {
        String emitterId = SecurityUtil.getSignInMemberEmail();
        log.info("üì° SSE Ïó∞Í≤∞ ÏöîÏ≤≠ - emitterId: {}", emitterId);

        if (emitterId == null || emitterId.isBlank()) {
            log.warn("‚ùå emitterIdÍ∞Ä nullÏù¥Í±∞ÎÇò Í≥µÎ∞±ÏûÖÎãàÎã§. Ïù∏Ï¶ùÎêú ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
        }

        SseEmitter emitter = new SseEmitter(TIME_OUT);
        sseRepository.save(emitterId, emitter);
        log.info("‚úÖ SSE emitter Ï†ÄÏû• ÏôÑÎ£å - ID: {}", emitterId);

        emitter.onCompletion(() -> {
            log.info("üßπ SSE Ïó∞Í≤∞ Ï¢ÖÎ£å (onCompletion) - ID: {}", emitterId);
            sseRepository.deleteById(emitterId);
        });

        emitter.onTimeout(() -> {
            log.warn("‚è±Ô∏è SSE ÌÉÄÏûÑÏïÑÏõÉ Î∞úÏÉù - ID: {}", emitterId);
            sseRepository.deleteById(emitterId);
        });

        try {
            emitter.send(SseEmitter.event().name("sse connect").data("connected"));
            log.info("‚úÖ SSE Ï¥àÍ∏∞ Î©îÏãúÏßÄ Ï†ÑÏÜ° ÏôÑÎ£å - ID: {}", emitterId);
        } catch (IOException e) {
            log.error("‚ùå SSE Ï¥àÍ∏∞ Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå® - ID: {}, Ïò§Î•ò: {}", emitterId, e.getMessage());
            sseRepository.deleteById(emitterId);
        }

        if (!lastEventId.isEmpty()) {
            resendMissedSseEvents(emitter, lastEventId);
        }

        return emitter;
    }

    /**
     * ÏïåÎ¶º Ï†ÑÏÜ°
     */
    public void sendSseNotification(String id, String message) {
        SseEmitter emitter = sseRepository.get(id);
        if (emitter == null) {
            log.warn("‚ùó SSE Emitter not found for ID: {}", id);
            return;
        }

        String eventId = String.valueOf(System.currentTimeMillis());

        try {
            log.info("üì§ SSE ÏïåÎ¶º Ï†ÑÏÜ° ÏãúÏûë - ID: {}, EventID: {}, Message: {}", id, eventId, message);

            emitter.send(SseEmitter.event()
                    .name("notification")
                    .data(message, MediaType.APPLICATION_JSON)
                    .id(eventId));

            sseRepository.saveEvent(eventId, message);

            log.info("‚úÖ SSE ÏïåÎ¶º Ï†ÑÏÜ° ÏôÑÎ£å - ID: {}, EventID: {}", id, eventId);

        } catch (IOException e) {
            log.error("‚ùå SSE Ï†ÑÏÜ° Ïã§Ìå® - ID: {}, Ïò§Î•ò: {}", id, e.getMessage());
            sseRepository.deleteById(id);
        }
    }


    /**
     * Ïú†Ïã§ Ïù¥Î≤§Ìä∏ Ïû¨Ï†ÑÏÜ°
     */
    private void resendMissedSseEvents(SseEmitter emitter, String lastEventId) {
        sseRepository.getEventCache().forEach((eventId, event) -> {
            if (Long.parseLong(eventId) > Long.parseLong(lastEventId)) {
                try {
                    emitter.send(SseEmitter.event().name("notification").data(event).id(eventId));
                } catch (IOException ignored) {
                }
            }
        });
    }

    /**
     * Ïø†Ìè∞ ÎßåÎ£å ÏûÑÎ∞ï ÏïåÎ¶º
     */
    @Transactional
    public void sendCouponAlmostExpiredNotification(
            String memberEmail, // ÏïåÎ¶ºÎäî Ïú†Ï†Ä Ïù¥Î©îÏùº
            String couponName, // Ïø†Ìè∞ Ïù¥Î¶Ñ
            Instant expiryDate // ÎßåÎ£å ÏùºÏûê
    ) {
        NotificationTemplate template = getTemplate(NotificationTemplateId.COUPON_ALMOST_EXPIRED);
        Instant now = Instant.now();

        String title = String.format(template.getTitle(), couponName);
        String message = String.format(template.getContent(), couponName, expiryDate.toString(), now);

        sendSseAndSaveNotification(memberEmail, template, title, message, now);
    }

    /**
     * ÏòàÎß§ ÏÑ±Í≥µ ÏïåÎ¶º
     */
    public void sendReservationSuccessNotification(ReservationSuccessEvent event) {
        sendPerformanceNotification(
                NotificationTemplateId.RESERVATION_SUCCESS,
                event.performance(),
                List.of(event.reservation()),
                event.member().getEmail()
        );
    }

    /**
     * Í≥µÏó∞ ÏàòÏ†ï ÏïåÎ¶º
     */
    public void sendPerformanceModifiedNotification(PerformanceModifiedEvent event) {
        sendPerformanceNotification(
                NotificationTemplateId.PERFORMANCE_MODIFIED,
                event.performance(),
                event.reservationList(),
                event.member().getEmail()
        );
    }

    /**
     * Í≥µÌÜµ Performance ÏïåÎ¶º Ï†ÑÏÜ°
     */
    private void sendPerformanceNotification(
            NotificationTemplateId templateId,
            PerformanceDto performance,
            List<ReservationDto> reservationList,
            String email
    ) {
        NotificationTemplate template = getTemplate(templateId);
        String title = String.format(template.getTitle(), performance.getTitle());

        if (templateId == NotificationTemplateId.RESERVATION_SUCCESS) {
            // Îã®Ïùº ÏòàÏïΩ ÏÑ±Í≥µ ÏïåÎ¶º
            ReservationDto reservation = reservationList.getFirst(); // ÎòêÎäî reservationList.get(0)
            List<ReservedSeatDto> seatList = reservationService.getSeatListByReservationId(reservation.getId());
            String seatCodes = seatList.stream()
                    .map(ReservedSeatDto::getSeatCode)
                    .collect(Collectors.joining("\n"));

            String message = String.format(
                    template.getContent(),
                    performance.getTitle(),
                    performance.getDate(),
                    seatCodes
            );

            sendSseAndSaveNotification(email, template, title, message, Instant.now());

        } else if (templateId == NotificationTemplateId.PERFORMANCE_MODIFIED) {
            // Í≥µÏó∞ Ï†ïÎ≥¥ ÏàòÏ†ï Ïãú Î™®Îì† ÏòàÎß§ Í±¥Ïóê ÎåÄÌï¥ Í∞ÅÍ∞Å ÏïåÎ¶º Ï†ÑÏÜ°
            if (reservationList.isEmpty()) {
                throw new BusinessException(ErrorCode.RESERVATION_NOT_FOUND);
            }

            for (ReservationDto reservation : reservationList) {
                String newTitle = "[Í≥µÏó∞Ï†úÎ™©]: " + performance.getTitle();
                String newDate = "[Ïùº  Ïûê]: " + performance.getDate();
                String newImg = "[Ïù¥ÎØ∏ÏßÄ]: " + performance.getImg();

                String newContent = String.join("\n", newTitle, newDate, newImg);

                String message = String.format(
                        template.getContent(),
                        newContent
                );

                sendSseAndSaveNotification(email, template, title, message, Instant.now());
            }

        } else {
            throw new BusinessException(ErrorCode.NOTIFICATION_TEMPLATE_NOT_FOUND);
        }
    }

    /**
     * ÏïåÎ¶º Ï†ÑÏÜ° + Ï†ÄÏû• + Î©îÏùº Î∞úÏÜ°
     */
    private void sendSseAndSaveNotification(
            String memberEmail, // Î∞õÎäî Ïú†Ï†Ä Ïù¥Î©îÏùº
            NotificationTemplate template, // ÌÖúÌîåÎ¶ø Ïú†Ìòï
            String title, // Ï†úÎ™©
            String message, // Î©îÏãúÏßÄ
            Instant createdAt // ÏÉùÏÑ±Ïùº
    ) {
        // SSE Ï†ÑÏÜ°
        NotificationSseResponseDto dto = NotificationSseResponseDto.builder()
                .title(title)
                .message(message)
                .build();

        String json = convertToJson(dto);
        sendSseNotification(memberEmail, json);

        // Î©îÏùº Î∞úÏÜ°
        mailService.sendSimpleMailMessage(memberEmail, title, message);
        // DB Ï†ÄÏû•
        Member member = memberService.getMemberByEmail(memberEmail);
        notificationRepository.save(Notification.builder()
                .receivedMember(member)
                .template(template)
                .title(title)
                .content(message)
                .status(statusService.getReadYetStatusForNotification())
                .createdAt(createdAt)
                .build());
    }

    /**
     * ÌÖúÌîåÎ¶ø Ï°∞Ìöå
     */
    private NotificationTemplate getTemplate(NotificationTemplateId templateId) {
        return notificationTemplateService.getNotificationTemplateById(templateId.getId());
    }

    // JsonÏúºÎ°ú Î≥ÄÌôòÌïòÎäî Î©îÏÑúÎìú
    private String convertToJson(Object obj) {
        try {
            return new ObjectMapper().writeValueAsString(obj);
        } catch (JsonProcessingException e) {
            log.error("‚ùå JSON ÏßÅÎ†¨Ìôî Ïã§Ìå®", e);
            return "{}";
        }
    }

}
