<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.profect.tickle.domain.settlement.mapper.SettlementResponseMapper">

    <!-- 정산 내역 조건별 분기 -->
    <select id="searchDefault" parameterType="map"
            resultType="com.profect.tickle.domain.settlement.dto.response.SettlementResponseDto">
        <choose>
            <!-- 건별 -->
            <when test="periodType == 'DETAIL'">
                SELECT
                date_trunc('second', sdt.settlement_detail_created_at)
                AT TIME ZONE 'ASIA/SEOUL'           AS settlementDate,
                sdt.performance_title               AS performanceTitle,
                sdt.settlement_detail_sales_amount  AS salesAmount,
                sdt.settlement_detail_refund_amount AS refundAmount,
                sdt.settlement_detail_gross_amount  AS grossAmount,
                sdt.settlement_detail_commission    AS commission,
                sdt.settlement_detail_net_amount    AS netAmount,
                sdt.contract_charge * 100           AS contractCharge,
                s.status_description                AS statusName
                FROM settlement_detail sdt
                JOIN status s ON sdt.status_id = s.status_id
                WHERE sdt.member_id = #{memberId}
                <if test="startDate != null and endDate != null">
                    AND sdt.settlement_detail_created_at::date
                    BETWEEN #{startDate} AND #{endDate}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sdt.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sdt.status_id = #{status.id}
                </if>
                ORDER BY sdt.settlement_detail_created_at DESC
                LIMIT #{limit} OFFSET #{offset}
            </when>
            <!-- 일별 -->
            <when test="periodType == 'DAILY'">
                SELECT
                date_trunc('second',
                greatest(
                sdy.settlement_daily_created_at,
                COALESCE(sdy.settlement_daily_updated_at, sdy.settlement_daily_created_at)
                )
                ) AT TIME ZONE 'ASIA/SEOUL'         AS settlementDate,
                sdy.performance_title               AS performanceTitle,
                sdy.settlement_daily_sales_amount   AS salesAmount,
                sdy.settlement_daily_refund_amount  AS refundAmount,
                sdy.settlement_daily_gross_amount   AS grossAmount,
                sdy.settlement_daily_commission     AS commission,
                sdy.settlement_daily_net_amount     AS netAmount,
                sdy.contract_charge * 100           AS contractCharge,
                s.status_description                AS statusName
                FROM settlement_daily sdy
                JOIN status s ON sdy.status_id = s.status_id
                WHERE sdy.member_id = #{memberId}
                <if test="startDate != null and endDate != null">
                    AND (sdy.settlement_year
                    || '-' || LPAD(sdy.settlement_month, 2, '0')
                    || '-' || LPAD(sdy.settlement_day, 2, '0'))::date
                    BETWEEN #{startDate} AND #{endDate}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sdy.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sdy.status_id = #{status.id}
                </if>
                ORDER BY settlementDate DESC
                LIMIT #{limit} OFFSET #{offset}
            </when>
            <!-- 주간 -->
            <when test="periodType == 'WEEKLY'">
                SELECT
                date_trunc('second',
                greatest(
                sw.settlement_weekly_created_at,
                COALESCE(sw.settlement_weekly_updated_at, sw.settlement_weekly_created_at)
                )
                ) AT TIME ZONE 'ASIA/SEOUL'         AS settlementDate,
                sw.settlement_year
                || '-' || LPAD(sw.settlement_month, 2, '0')
                || '-' || LPAD(sw.settlement_week, 2, '0') AS settlementCycle,
                sw.performance_title                AS performanceTitle,
                sw.settlement_weekly_sales_amount   AS salesAmount,
                sw.settlement_weekly_refund_amount  AS refundAmount,
                sw.settlement_weekly_gross_amount   AS grossAmount,
                sw.settlement_weekly_commission     AS commission,
                sw.settlement_weekly_net_amount     AS netAmount,
                ROUND(sw.settlement_weekly_commission::NUMERIC
                / NULLIF(sw.settlement_weekly_gross_amount, 0), 2) * 100 AS contractCharge,
                s.status_description                AS statusName
                FROM settlement_weekly sw
                JOIN status s ON sw.status_id = s.status_id
                WHERE sw.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sw.settlement_year
                    || '-' || LPAD(sw.settlement_month, 2, '0')
                    || '-' || LPAD(sw.settlement_week, 2, '0'))
                    = #{settlementCycle}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sw.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sw.status_id = #{status.id}
                </if>
                ORDER BY settlementDate DESC
                LIMIT #{limit} OFFSET #{offset}
            </when>
            <!-- 월간 -->
            <when test="periodType == 'MONTHLY'">
                SELECT
                date_trunc('second',
                greatest(
                sm.settlement_monthly_created_at,
                COALESCE(sm.settlement_monthly_updated_at, sm.settlement_monthly_created_at)
                )
                ) AT TIME ZONE 'ASIA/SEOUL'         AS settlementDate,
                sm.settlement_year
                || '-' || LPAD(sm.settlement_month, 2, '0') AS settlementCycle,
                sm.performance_title                AS performanceTitle,
                sm.settlement_monthly_sales_amount  AS salesAmount,
                sm.settlement_monthly_refund_amount AS refundAmount,
                sm.settlement_monthly_gross_amount  AS grossAmount,
                sm.settlement_monthly_commission    AS commission,
                sm.settlement_monthly_net_amount    AS netAmount,
                ROUND(sm.settlement_monthly_commission::NUMERIC
                / NULLIF(sm.settlement_monthly_gross_amount, 0), 2) * 100 AS contractCharge,
                s.status_description                AS statusName
                FROM settlement_monthly sm
                JOIN status s ON sm.status_id = s.status_id
                WHERE sm.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sm.settlement_year
                    || '-' || LPAD(sm.settlement_month, 2, '0'))::TEXT
                    = #{settlementCycle}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sm.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sm.status_id = #{status.id}
                </if>
                ORDER BY settlementDate DESC
                LIMIT #{limit} OFFSET #{offset}
            </when>
        </choose>
    </select>

    <!-- 주최자별 정산 내역 합산 조회 -->
    <select id="searchByHost" parameterType="map"
            resultType="com.profect.tickle.domain.settlement.dto.response.SettlementResponseDto">
        <choose>
            <!-- 일별: 주최자별 합산 -->
            <when test="periodType == 'DAILY'">
                SELECT
                (sdy.settlement_year
                || '-' || LPAD(sdy.settlement_month, 2, '0')
                || '-' || LPAD(sdy.settlement_day, 2, '0'))::text AS settlementCycle,
                '전체 공연'                                AS performanceTitle,
                SUM(sdy.settlement_daily_sales_amount)   AS salesAmount,
                SUM(sdy.settlement_daily_refund_amount)  AS refundAmount,
                SUM(sdy.settlement_daily_gross_amount)   AS grossAmount,
                SUM(sdy.settlement_daily_commission)     AS commission,
                SUM(sdy.settlement_daily_net_amount)     AS netAmount,
                ROUND(
                SUM(sdy.settlement_daily_commission)::NUMERIC
                / NULLIF(SUM(sdy.settlement_daily_gross_amount), 0), 2
                ) * 100                                 AS contractCharge,
                s.status_description                    AS statusName
                FROM settlement_daily sdy
                JOIN status s ON sdy.status_id = s.status_id
                WHERE sdy.member_id = #{memberId}
                <if test="startDate != null and endDate != null">
                    AND (sdy.settlement_year
                    || '-' || LPAD(sdy.settlement_month, 2, '0')
                    || '-' || LPAD(sdy.settlement_day, 2, '0'))::date
                    BETWEEN #{startDate} AND #{endDate}
                </if>
                <if test="status != null">
                    AND sdy.status_id = #{status.id}
                </if>
                GROUP BY
                sdy.settlement_year,
                sdy.settlement_month,
                sdy.settlement_day,
                s.status_description
                ORDER BY settlementCycle DESC
                LIMIT #{limit} OFFSET #{offset}
            </when>
            <!-- 주간: 주최자별 합산 -->
            <when test="periodType == 'WEEKLY'">
                SELECT
                (sw.settlement_year
                || '-' || LPAD(sw.settlement_month, 2, '0')
                || '-' || LPAD(sw.settlement_week, 2, '0'))::text AS settlementCycle,
                '전체 공연'                                AS performanceTitle,
                SUM(sw.settlement_weekly_sales_amount)   AS salesAmount,
                SUM(sw.settlement_weekly_refund_amount)  AS refundAmount,
                SUM(sw.settlement_weekly_gross_amount)   AS grossAmount,
                SUM(sw.settlement_weekly_commission)     AS commission,
                SUM(sw.settlement_weekly_net_amount)     AS netAmount,
                ROUND(
                SUM(sw.settlement_weekly_commission)::NUMERIC
                / NULLIF(SUM(sw.settlement_weekly_gross_amount), 0), 2
                ) * 100                                 AS contractCharge,
                s.status_description                    AS statusName
                FROM settlement_weekly sw
                JOIN status s ON sw.status_id = s.status_id
                WHERE sw.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sw.settlement_year
                    || '-' || LPAD(sw.settlement_month, 2, '0')
                    || '-' || LPAD(sw.settlement_week, 2, '0'))
                    = #{settlementCycle}
                </if>
                <if test="status != null">
                    AND sw.status_id = #{status.id}
                </if>
                GROUP BY
                sw.settlement_year,
                sw.settlement_month,
                sw.settlement_week,
                s.status_description
                ORDER BY settlementCycle DESC
                LIMIT #{limit} OFFSET #{offset}
            </when>
            <!-- 월간: 주최자별 합산 -->
            <when test="periodType == 'MONTHLY'">
                SELECT
                (sm.settlement_year
                || '-' || LPAD(sm.settlement_month, 2, '0'))::text AS settlementCycle,
                '전체 공연'                                AS performanceTitle,
                SUM(sm.settlement_monthly_sales_amount)  AS salesAmount,
                SUM(sm.settlement_monthly_refund_amount) AS refundAmount,
                SUM(sm.settlement_monthly_gross_amount)  AS grossAmount,
                SUM(sm.settlement_monthly_commission)    AS commission,
                SUM(sm.settlement_monthly_net_amount)    AS netAmount,
                ROUND(
                SUM(sm.settlement_monthly_commission)::NUMERIC
                / NULLIF(SUM(sm.settlement_monthly_gross_amount), 0), 2
                ) * 100                                  AS contractCharge,
                s.status_description                AS statusName
                FROM settlement_monthly sm
                JOIN status s ON sm.status_id = s.status_id
                WHERE sm.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sm.settlement_year
                    || '-' || LPAD(sm.settlement_month, 2, '0'))::TEXT
                    = #{settlementCycle}
                </if>
                <if test="status != null">
                    AND sm.status_id = #{status.id}
                </if>
                GROUP BY
                sm.settlement_year,
                sm.settlement_month,
                s.status_description
                ORDER BY settlementCycle DESC
                LIMIT #{limit} OFFSET #{offset}
            </when>
        </choose>
    </select>

    <!-- 디폴트 조회 총 건수 -->
    <select id="searchDefaultCnt" resultType="int">
        <choose>
            <!-- 건별 -->
            <when test="periodType == 'DETAIL'">
                SELECT COUNT(*)
                FROM settlement_detail sdt
                JOIN status s ON sdt.status_id = s.status_id
                WHERE sdt.member_id = #{memberId}
                <if test="startDate != null and endDate != null">
                    AND sdt.settlement_detail_created_at::date
                    BETWEEN #{startDate} AND #{endDate}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sdt.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sdt.status_id = #{status.id}
                </if>
            </when>
            <!-- 일별 -->
            <when test="periodType == 'DAILY'">
                SELECT COUNT(*)
                FROM settlement_daily sdy
                JOIN status s ON sdy.status_id = s.status_id
                WHERE sdy.member_id = #{memberId}
                <if test="startDate != null and endDate != null">
                    AND (sdy.settlement_year
                    || '-' || LPAD(sdy.settlement_month, 2, '0')
                    || '-' || LPAD(sdy.settlement_day, 2, '0'))::date
                    BETWEEN #{startDate} AND #{endDate}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sdy.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sdy.status_id = #{status.id}
                </if>
            </when>
            <!-- 주간 -->
            <when test="periodType == 'WEEKLY'">
                SELECT COUNT(*)
                FROM settlement_weekly sw
                JOIN status s ON sw.status_id = s.status_id
                WHERE sw.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sw.settlement_year
                    || '-' || LPAD(sw.settlement_month, 2, '0')
                    || '-' || LPAD(sw.settlement_week, 2, '0'))
                    = #{settlementCycle}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sw.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sw.status_id = #{status.id}
                </if>
            </when>
            <!-- 월간 -->
            <when test="periodType == 'MONTHLY'">
                SELECT COUNT(*)
                FROM settlement_monthly sm
                JOIN status s ON sm.status_id = s.status_id
                WHERE sm.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sm.settlement_year
                    || '-' || LPAD(sm.settlement_month, 2, '0'))::TEXT
                    = #{settlementCycle}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sm.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sm.status_id = #{status.id}
                </if>
            </when>
        </choose>
    </select>

    <!-- 주최자별 정산 내역 총 건수 -->
    <select id="searchByHostCnt" resultType="int">
        <choose>
            <!-- 일별: 주최자별 합산 총 건수 -->
            <when test="periodType == 'DAILY'">
                SELECT COUNT(*) FROM (
                SELECT 1
                FROM settlement_daily sdy
                JOIN status s ON sdy.status_id = s.status_id
                WHERE sdy.member_id = #{memberId}
                <if test="startDate != null and endDate != null">
                    AND (sdy.settlement_year
                    || '-' || LPAD(sdy.settlement_month, 2, '0')
                    || '-' || LPAD(sdy.settlement_day, 2, '0'))::date
                    BETWEEN #{startDate} AND #{endDate}
                </if>
                <if test="status != null">
                    AND sdy.status_id = #{status.id}
                </if>
                GROUP BY
                sdy.settlement_year,
                sdy.settlement_month,
                sdy.settlement_day,
                s.status_description
                ) AS grouped_data
            </when>

            <!-- 주간: 주최자별 합산 총 건수 -->
            <when test="periodType == 'WEEKLY'">
                SELECT COUNT(*) FROM (
                SELECT 1
                FROM settlement_weekly sw
                JOIN status s ON sw.status_id = s.status_id
                WHERE sw.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sw.settlement_year
                    || '-' || LPAD(sw.settlement_month, 2, '0')
                    || '-' || LPAD(sw.settlement_week, 2, '0'))
                    = #{settlementCycle}
                </if>
                <if test="status != null">
                    AND sw.status_id = #{status.id}
                </if>
                GROUP BY
                sw.settlement_year,
                sw.settlement_month,
                sw.settlement_week,
                s.status_description
                ) AS grouped_data
            </when>

            <!-- 월간: 주최자별 합산 총 건수 -->
            <when test="periodType == 'MONTHLY'">
                SELECT COUNT(*) FROM (
                SELECT 1
                FROM settlement_monthly sm
                JOIN status s ON sm.status_id = s.status_id
                WHERE sm.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sm.settlement_year
                    || '-' || LPAD(sm.settlement_month, 2, '0'))::TEXT
                    = #{settlementCycle}
                </if>
                <if test="status != null">
                    AND sm.status_id = #{status.id}
                </if>
                GROUP BY
                sm.settlement_year,
                sm.settlement_month,
                s.status_description
                ) AS grouped_data
            </when>
        </choose>
    </select>

    <!-- 엑셀 다운로드용 청크 단위 쿼리 -->
    <select id="searchForExcel" parameterType="map"
            resultType="com.profect.tickle.domain.settlement.dto.response.SettlementResponseDto">
        <choose>
            <!-- 건별 -->
            <when test="periodType == 'DETAIL'">
                SELECT
                date_trunc('second', sdt.settlement_detail_created_at)
                AT TIME ZONE 'ASIA/SEOUL'           AS settlementDate,
                sdt.performance_title               AS performanceTitle,
                sdt.settlement_detail_sales_amount  AS salesAmount,
                sdt.settlement_detail_refund_amount AS refundAmount,
                sdt.settlement_detail_gross_amount  AS grossAmount,
                sdt.settlement_detail_commission    AS commission,
                sdt.settlement_detail_net_amount    AS netAmount,
                sdt.contract_charge * 100           AS contractCharge,
                s.status_description                AS statusName
                FROM settlement_detail sdt
                JOIN status s ON sdt.status_id = s.status_id
                WHERE sdt.member_id = #{memberId}
                <if test="startDate != null and endDate != null">
                    AND sdt.settlement_detail_created_at::date
                    BETWEEN #{startDate} AND #{endDate}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sdt.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sdt.status_id = #{status.id}
                </if>
                ORDER BY sdt.settlement_detail_created_at DESC
                LIMIT #{chunkSize} OFFSET #{offset}
            </when>
            <!-- 일별 -->
            <when test="periodType == 'DAILY'">
                SELECT
                date_trunc('second',
                greatest(
                sdy.settlement_daily_created_at,
                COALESCE(sdy.settlement_daily_updated_at, sdy.settlement_daily_created_at)
                )
                ) AT TIME ZONE 'ASIA/SEOUL'         AS settlementDate,
                sdy.performance_title               AS performanceTitle,
                sdy.settlement_daily_sales_amount   AS salesAmount,
                sdy.settlement_daily_refund_amount  AS refundAmount,
                sdy.settlement_daily_gross_amount   AS grossAmount,
                sdy.settlement_daily_commission     AS commission,
                sdy.settlement_daily_net_amount     AS netAmount,
                sdy.contract_charge * 100           AS contractCharge,
                s.status_description                AS statusName
                FROM settlement_daily sdy
                JOIN status s ON sdy.status_id = s.status_id
                WHERE sdy.member_id = #{memberId}
                <if test="startDate != null and endDate != null">
                    AND (sdy.settlement_year
                    || '-' || LPAD(sdy.settlement_month, 2, '0')
                    || '-' || LPAD(sdy.settlement_day, 2, '0'))::date
                    BETWEEN #{startDate} AND #{endDate}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sdy.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sdy.status_id = #{status.id}
                </if>
                ORDER BY settlementDate DESC
                LIMIT #{chunkSize} OFFSET #{offset}
            </when>
            <!-- 주간 -->
            <when test="periodType == 'WEEKLY'">
                SELECT
                date_trunc('second',
                greatest(
                sw.settlement_weekly_created_at,
                COALESCE(sw.settlement_weekly_updated_at, sw.settlement_weekly_created_at)
                )
                ) AT TIME ZONE 'ASIA/SEOUL'         AS settlementDate,
                sw.settlement_year
                || '-' || LPAD(sw.settlement_month, 2, '0')
                || '-' || LPAD(sw.settlement_week, 2, '0') AS settlementCycle,
                sw.performance_title                AS performanceTitle,
                sw.settlement_weekly_sales_amount   AS salesAmount,
                sw.settlement_weekly_refund_amount  AS refundAmount,
                sw.settlement_weekly_gross_amount   AS grossAmount,
                sw.settlement_weekly_commission     AS commission,
                sw.settlement_weekly_net_amount     AS netAmount,
                ROUND(sw.settlement_weekly_commission::NUMERIC
                / NULLIF(sw.settlement_weekly_gross_amount, 0), 2) * 100 AS contractCharge,
                s.status_description                AS statusName
                FROM settlement_weekly sw
                JOIN status s ON sw.status_id = s.status_id
                WHERE sw.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sw.settlement_year
                    || '-' || LPAD(sw.settlement_month, 2, '0')
                    || '-' || LPAD(sw.settlement_week, 2, '0'))
                    = #{settlementCycle}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sw.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sw.status_id = #{status.id}
                </if>
                ORDER BY settlementDate DESC
                LIMIT #{chunkSize} OFFSET #{offset}
            </when>
            <!-- 월간 -->
            <when test="periodType == 'MONTHLY'">
                SELECT
                date_trunc('second',
                greatest(
                sm.settlement_monthly_created_at,
                COALESCE(sm.settlement_monthly_updated_at, sm.settlement_monthly_created_at)
                )
                ) AT TIME ZONE 'ASIA/SEOUL'         AS settlementDate,
                sm.settlement_year
                || '-' || LPAD(sm.settlement_month, 2, '0') AS settlementCycle,
                sm.performance_title                AS performanceTitle,
                sm.settlement_monthly_sales_amount  AS salesAmount,
                sm.settlement_monthly_refund_amount AS refundAmount,
                sm.settlement_monthly_gross_amount  AS grossAmount,
                sm.settlement_monthly_commission    AS commission,
                sm.settlement_monthly_net_amount    AS netAmount,
                ROUND(sm.settlement_monthly_commission::NUMERIC
                / NULLIF(sm.settlement_monthly_gross_amount, 0), 2) * 100 AS contractCharge,
                s.status_description                AS statusName
                FROM settlement_monthly sm
                JOIN status s ON sm.status_id = s.status_id
                WHERE sm.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sm.settlement_year
                    || '-' || LPAD(sm.settlement_month, 2, '0'))::TEXT
                    = #{settlementCycle}
                </if>
                <if test="performanceTitle != null and performanceTitle != ''">
                    AND sm.performance_title ILIKE '%' || #{performanceTitle} || '%'
                </if>
                <if test="status != null">
                    AND sm.status_id = #{status.id}
                </if>
                ORDER BY settlementDate DESC
                LIMIT #{chunkSize} OFFSET #{offset}
            </when>
        </choose>
    </select>

    <!-- Host View용 엑셀 다운로드 쿼리 -->
    <select id="searchByHostForExcel" parameterType="map"
            resultType="com.profect.tickle.domain.settlement.dto.response.SettlementResponseDto">
        <choose>
            <!-- 일별: 주최자별 합산 -->
            <when test="periodType == 'DAILY'">
                SELECT
                (sdy.settlement_year
                || '-' || LPAD(sdy.settlement_month, 2, '0')
                || '-' || LPAD(sdy.settlement_day, 2, '0'))::text AS settlementCycle,
                '전체 공연'                                AS performanceTitle,
                SUM(sdy.settlement_daily_sales_amount)   AS salesAmount,
                SUM(sdy.settlement_daily_refund_amount)  AS refundAmount,
                SUM(sdy.settlement_daily_gross_amount)   AS grossAmount,
                SUM(sdy.settlement_daily_commission)     AS commission,
                SUM(sdy.settlement_daily_net_amount)     AS netAmount,
                ROUND(
                SUM(sdy.settlement_daily_commission)::NUMERIC
                / NULLIF(SUM(sdy.settlement_daily_gross_amount), 0), 2
                ) * 100                                 AS contractCharge,
                s.status_description                    AS statusName
                FROM settlement_daily sdy
                JOIN status s ON sdy.status_id = s.status_id
                WHERE sdy.member_id = #{memberId}
                <if test="startDate != null and endDate != null">
                    AND (sdy.settlement_year
                    || '-' || LPAD(sdy.settlement_month, 2, '0')
                    || '-' || LPAD(sdy.settlement_day, 2, '0'))::date
                    BETWEEN #{startDate} AND #{endDate}
                </if>
                <if test="status != null">
                    AND sdy.status_id = #{status.id}
                </if>
                GROUP BY
                sdy.settlement_year,
                sdy.settlement_month,
                sdy.settlement_day,
                s.status_description
                ORDER BY settlementCycle DESC
                LIMIT #{chunkSize} OFFSET #{offset}
            </when>
            <!-- 주간: 주최자별 합산 -->
            <when test="periodType == 'WEEKLY'">
                SELECT
                (sw.settlement_year
                || '-' || LPAD(sw.settlement_month, 2, '0')
                || '-' || LPAD(sw.settlement_week, 2, '0'))::text AS settlementCycle,
                '전체 공연'                                AS performanceTitle,
                SUM(sw.settlement_weekly_sales_amount)   AS salesAmount,
                SUM(sw.settlement_weekly_refund_amount)  AS refundAmount,
                SUM(sw.settlement_weekly_gross_amount)   AS grossAmount,
                SUM(sw.settlement_weekly_commission)     AS commission,
                SUM(sw.settlement_weekly_net_amount)     AS netAmount,
                ROUND(
                SUM(sw.settlement_weekly_commission)::NUMERIC
                / NULLIF(SUM(sw.settlement_weekly_gross_amount), 0), 2
                ) * 100                                 AS contractCharge,
                s.status_description                    AS statusName
                FROM settlement_weekly sw
                JOIN status s ON sw.status_id = s.status_id
                WHERE sw.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sw.settlement_year
                    || '-' || LPAD(sw.settlement_month, 2, '0')
                    || '-' || LPAD(sw.settlement_week, 2, '0'))
                    = #{settlementCycle}
                </if>
                <if test="status != null">
                    AND sw.status_id = #{status.id}
                </if>
                GROUP BY
                sw.settlement_year,
                sw.settlement_month,
                sw.settlement_week,
                s.status_description
                ORDER BY settlementCycle DESC
                LIMIT #{chunkSize} OFFSET #{offset}
            </when>
            <!-- 월간: 주최자별 합산 -->
            <when test="periodType == 'MONTHLY'">
                SELECT
                (sm.settlement_year
                || '-' || LPAD(sm.settlement_month, 2, '0'))::text AS settlementCycle,
                '전체 공연'                                AS performanceTitle,
                SUM(sm.settlement_monthly_sales_amount)  AS salesAmount,
                SUM(sm.settlement_monthly_refund_amount) AS refundAmount,
                SUM(sm.settlement_monthly_gross_amount)  AS grossAmount,
                SUM(sm.settlement_monthly_commission)    AS commission,
                SUM(sm.settlement_monthly_net_amount)    AS netAmount,
                ROUND(
                SUM(sm.settlement_monthly_commission)::NUMERIC
                / NULLIF(SUM(sm.settlement_monthly_gross_amount), 0), 2
                ) * 100                                  AS contractCharge,
                s.status_description                AS statusName
                FROM settlement_monthly sm
                JOIN status s ON sm.status_id = s.status_id
                WHERE sm.member_id = #{memberId}
                <if test="settlementCycle != null">
                    AND (sm.settlement_year
                    || '-' || LPAD(sm.settlement_month, 2, '0'))::TEXT
                    = #{settlementCycle}
                </if>
                <if test="status != null">
                    AND sm.status_id = #{status.id}
                </if>
                GROUP BY
                sm.settlement_year,
                sm.settlement_month,
                s.status_description
                ORDER BY settlementCycle DESC
                LIMIT #{chunkSize} OFFSET #{offset}
            </when>
        </choose>
    </select>
</mapper>