<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.profect.tickle.domain.chat.mapper.ChatRoomMapper">

    <!-- 채팅방 상세 정보 조회 (참여자 수, 읽지않은 메시지 등 포함) -->
    <select id="findRoomDetailsByPerformanceId" resultType="ChatRoomResponseDto">
        SELECT
            cr.chat_room_id,
            cr.performance_id,
            cr.chat_room_name,
            cr.chat_room_status,
            cr.chat_room_max_participants,
            cr.chat_room_created_at,
            cr.chat_room_updated_at,

            -- 현재 참여자 수
            (SELECT COUNT(*)
             FROM chat_participants cp
             WHERE cp.chat_room_id = cr.chat_room_id
               AND cp.chat_participants_status = true) as participant_count,

            -- 현재 사용자 참여 여부
            (SELECT CASE WHEN COUNT(*) > 0 THEN true ELSE false END
             FROM chat_participants cp
             WHERE cp.chat_room_id = cr.chat_room_id
               AND cp.member_id = #{currentMemberId}
               AND cp.chat_participants_status = true) as is_participant,

            -- 읽지않은 메시지 개수 (참여 중인 경우에만)
            COALESCE(
                    (SELECT COUNT(*)
                     FROM chat c
                              INNER JOIN chat_participants cp ON cp.chat_room_id = c.chat_room_id
                     WHERE c.chat_room_id = cr.chat_room_id
                       AND cp.member_id = #{currentMemberId}
                       AND cp.chat_participants_status = true
                       AND c.chat_id > COALESCE(cp.chat_participants_last_read_message_id, 0)
                       AND c.chat_is_deleted = false), 0
            ) as unread_count

        FROM chat_room cr
        WHERE cr.performance_id = #{performanceId}
          AND cr.chat_room_status = true
    </select>

    <!-- 사용자가 해당 채팅방에 참여 중인지 확인 -->
    <select id="isParticipant" resultType="boolean">
        SELECT
            CASE WHEN COUNT(*) > 0 THEN true ELSE false END
        FROM chat_participants cp
        WHERE cp.chat_room_id = #{roomId}
          AND cp.member_id = #{memberId}
          AND cp.chat_participants_status = true
    </select>

</mapper>
