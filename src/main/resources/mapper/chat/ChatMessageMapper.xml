<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.profect.tickle.domain.chat.mapper.ChatMessageMapper">

    <!-- 채팅방 메시지 목록 조회 (페이징) -->
    <select id="findMessagesByRoomId" resultType="ChatMessageResponseDto">
        SELECT
        c.chat_id,
        c.chat_room_id,
        c.member_id,
        c.chat_message_type,
        c.chat_content,
        c.chat_created_at,
        c.chat_sender_status,
        c.chat_file_path,
        c.chat_file_name,
        c.chat_file_size,
        c.chat_file_type,

        -- 발신자 닉네임 (탈퇴한 회원 처리)
        CASE
        WHEN c.chat_sender_status = false THEN '탈퇴한 회원입니다'
        WHEN m.member_id IS NULL THEN '탈퇴한 회원입니다'
        ELSE m.member_nickname
        END as sender_nickname,

        -- 내 메시지 여부
        CASE
        WHEN c.member_id = #{currentMemberId} THEN true
        ELSE false
        END as is_my_message

        FROM chat c
        LEFT JOIN member m ON c.member_id = m.member_id
        WHERE c.chat_room_id = #{roomId}
        AND c.chat_is_deleted = false

        <if test="lastMessageId != null">
            AND c.chat_id > #{lastMessageId}
        </if>

        ORDER BY c.chat_created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 채팅방 전체 메시지 개수 조회 -->
    <select id="countTotalMessages" resultType="int">
        SELECT COUNT(*)
        FROM chat c
        WHERE c.chat_room_id = #{roomId}
        AND c.chat_is_deleted = false

        <if test="lastMessageId != null">
            AND c.chat_id > #{lastMessageId}
        </if>
    </select>

    <!-- 읽지않은 메시지 개수 조회 -->
    <select id="countUnreadMessages" resultType="int">
        SELECT COUNT(*)
        FROM chat c
        WHERE c.chat_room_id = #{roomId}
          AND c.chat_is_deleted = false
          AND c.chat_id > COALESCE(#{lastReadMessageId}, 0)
    </select>

    <!-- 채팅방의 마지막 메시지 조회 -->
    <select id="findLastMessageByRoomId" resultType="ChatMessageResponseDto">
        SELECT
            c.chat_id,
            c.chat_room_id,
            c.member_id,
            c.chat_message_type,
            c.chat_content,
            c.chat_created_at,
            c.chat_sender_status,

            -- 발신자 닉네임
            CASE
                WHEN c.chat_sender_status = false THEN '탈퇴한 회원입니다'
                WHEN m.member_id IS NULL THEN '탈퇴한 회원입니다'
                ELSE m.member_nickname
                END as sender_nickname

        FROM chat c
                 LEFT JOIN member m ON c.member_id = m.member_id
        WHERE c.chat_room_id = #{roomId}
          AND c.chat_is_deleted = false
        ORDER BY c.chat_created_at DESC
            LIMIT 1
    </select>

</mapper>
