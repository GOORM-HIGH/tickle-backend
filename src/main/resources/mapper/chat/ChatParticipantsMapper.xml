<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.profect.tickle.domain.chat.mapper.ChatParticipantsMapper">

    <!-- 채팅방 참여자 목록 조회 (닉네임 포함) -->
    <select id="findParticipantsByRoomId" resultType="ChatParticipantsResponseDto">
        SELECT
            cp.chat_participants_id,
            cp.chat_room_id,
            cp.member_id,
            cp.chat_participants_joined_at,
            cp.chat_participants_status,
            cp.chat_participants_last_read_at,
            cp.chat_participants_last_read_message_id,

            -- 참여자 닉네임
            m.member_nickname as member_nickname,

            -- 읽지않은 메시지 개수
            (SELECT COUNT(*)
             FROM chat c
             WHERE c.chat_room_id = #{roomId}
               AND c.chat_id > COALESCE(cp.chat_participants_last_read_message_id, 0)
               AND c.chat_is_deleted = false) as unread_message_count

        FROM chat_participants cp
                 INNER JOIN member m ON cp.member_id = m.member_id
        WHERE cp.chat_room_id = #{roomId}
          AND cp.chat_participants_status = true
        ORDER BY cp.chat_participants_joined_at ASC
    </select>

    <!-- 읽음 상태 업데이트 -->
    <update id="updateLastReadMessage">
        UPDATE chat_participants
        SET
            chat_participants_last_read_message_id = #{messageId},
            chat_participants_last_read_at = #{readAt}
        WHERE chat_room_id = #{roomId}
          AND member_id = #{memberId}
          AND chat_participants_status = true
    </update>

    <!-- 사용자의 읽음 상태 조회 -->
    <select id="getReadStatus" resultType="UnreadCountResponseDto">
        SELECT
            COALESCE(
                    (SELECT COUNT(*)
                     FROM chat c
                     WHERE c.chat_room_id = #{roomId}
                       AND c.chat_id > COALESCE(cp.chat_participants_last_read_message_id, 0)
                       AND c.chat_is_deleted = false), 0
            ) as unread_count,
            cp.chat_participants_last_read_message_id,
            cp.chat_participants_last_read_at
        FROM chat_participants cp
        WHERE cp.chat_room_id = #{roomId}
          AND cp.member_id = #{memberId}
          AND cp.chat_participants_status = true
    </select>

    <!-- 채팅방 참여자 수 조회 -->
    <select id="countActiveParticipants" resultType="int">
        SELECT COUNT(*)
        FROM chat_participants cp
        WHERE cp.chat_room_id = #{roomId}
          AND cp.chat_participants_status = true
    </select>

    <!-- 사용자가 참여 중인 채팅방 목록 조회 (복잡한 정보 포함) -->
    <select id="findMyChatRooms" resultType="ChatParticipantsResponseDto">
        SELECT
            cp.chat_participants_id,
            cp.chat_room_id,
            cp.member_id,
            cp.chat_participants_joined_at,
            cp.chat_participants_status,
            cp.chat_participants_last_read_at,
            cp.chat_participants_last_read_message_id,

            -- 읽지않은 메시지 개수
            (SELECT COUNT(*)
             FROM chat c
             WHERE c.chat_room_id = cp.chat_room_id
               AND c.chat_id > COALESCE(cp.chat_participants_last_read_message_id, 0)
               AND c.chat_is_deleted = false) as unread_message_count

        FROM chat_participants cp
                 INNER JOIN chat_room cr ON cp.chat_room_id = cr.chat_room_id
        WHERE cp.member_id = #{memberId}
          AND cp.chat_participants_status = true
          AND cr.chat_room_status = true
        ORDER BY
            -- 읽지않은 메시지가 있는 채팅방을 먼저 정렬
            (CASE WHEN (SELECT COUNT(*)
                        FROM chat c
                        WHERE c.chat_room_id = cp.chat_room_id
                          AND c.chat_id > COALESCE(cp.chat_participants_last_read_message_id, 0)
                          AND c.chat_is_deleted = false) > 0 THEN 0 ELSE 1 END),
            cr.chat_room_updated_at DESC
    </select>

</mapper>
